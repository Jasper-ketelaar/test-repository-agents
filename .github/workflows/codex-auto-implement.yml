name: Codex Auto-Implement

on:
  workflow_call:
    inputs:
      issue-number:
        description: GitHub issue number to implement
        required: true
        type: string
      base-branch:
        description: Base branch to create the feature branch from
        required: false
        default: main
        type: string
      extra-prompt:
        description: Additional instructions appended to the Codex prompt
        required: false
        default: ''
        type: string
      pr-labels:
        description: Comma-separated labels to apply to the created PR
        required: false
        default: codex-generated
        type: string
      timeout-minutes:
        description: Timeout in minutes for each Codex phase
        required: false
        default: '30'
        type: string
      factory-api-url:
        description: Factory backend base URL (optional)
        required: false
        default: ''
        type: string
      factory-run-id:
        description: Optional run ID override for Factory backend tracking
        required: false
        default: ''
        type: string
      agents-repository:
        description: Repository that contains factory-agents scripts
        required: false
        default: Jasper-ketelaar/test-repository-agents
        type: string
      agents-ref:
        description: Ref (branch/tag/SHA) for factory-agents scripts repository
        required: false
        default: main
        type: string
    secrets:
      repo-token:
        description: GitHub token with contents/issues/pull-requests write permissions
        required: true
      factory-api-token:
        description: Shared token for factory backend updates (optional)
        required: false

    outputs:
      pr-number:
        description: The created pull request number
        value: ${{ jobs.implement.outputs.pr-number }}
      pr-url:
        description: The created pull request URL
        value: ${{ jobs.implement.outputs.pr-url }}

jobs:
  implement:
    name: Research, Plan, Implement, Review
    runs-on: [self-hosted, macOS]
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      GH_TOKEN: ${{ secrets.repo-token }}
      GITHUB_TOKEN: ${{ secrets.repo-token }}
      ISSUE_NUMBER: ${{ inputs.issue-number }}
      BASE_BRANCH: ${{ inputs.base-branch }}
      EXTRA_PROMPT: ${{ inputs.extra-prompt }}
      PR_LABELS: ${{ inputs.pr-labels }}
      TIMEOUT_MINUTES: ${{ inputs.timeout-minutes }}
      FACTORY_API_URL: ${{ inputs.factory-api-url }}
      FACTORY_API_TOKEN: ${{ secrets.factory-api-token }}
      FACTORY_RUN_ID: ${{ inputs.factory-run-id }}
    outputs:
      pr-number: ${{ steps.implement.outputs.pr-number }}
      pr-url: ${{ steps.implement.outputs.pr-url }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base-branch }}
          token: ${{ secrets.repo-token }}
          clean: true

      - name: Setup agent scripts
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.agents-repository }}
          ref: ${{ inputs.agents-ref }}
          token: ${{ secrets.repo-token }}
          path: .factory-agents-src

      - name: Set action path
        shell: bash
        run: |
          echo "ACTION_PATH=${GITHUB_WORKSPACE}/.factory-agents-src" >> "$GITHUB_ENV"

      - name: Ensure GitHub CLI is installed
        shell: bash
        run: |
          if command -v gh >/dev/null 2>&1; then
            exit 0
          fi

          echo "gh CLI not found, attempting installation..."

          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y gh
          elif command -v brew >/dev/null 2>&1; then
            brew install gh
          else
            echo "Unable to install gh automatically (no apt-get or brew available)." >&2
            exit 1
          fi

          command -v gh >/dev/null 2>&1 || {
            echo "gh installation failed or gh is still not on PATH." >&2
            exit 1
          }

      - name: Prepare scripts
        shell: bash
        run: |
          chmod +x \
            "$ACTION_PATH/scripts/implement-issue.sh" \
            "$ACTION_PATH/scripts/research.sh" \
            "$ACTION_PATH/scripts/plan.sh" \
            "$ACTION_PATH/scripts/implement.sh" \
            "$ACTION_PATH/scripts/review.sh"

      - name: Announce run start to Factory
        shell: bash
        env:
          FACTORY_API_URL: ${{ inputs.factory-api-url }}
          FACTORY_API_TOKEN: ${{ secrets.factory-api-token }}
          FACTORY_RUN_ID: ${{ inputs.factory-run-id }}
          ISSUE_NUMBER: ${{ inputs.issue-number }}
        run: |
          if [[ -z "${FACTORY_API_URL:-}" || -z "${FACTORY_API_TOKEN:-}" ]]; then
            exit 0
          fi

          if ! command -v curl >/dev/null 2>&1 || ! command -v jq >/dev/null 2>&1; then
            exit 0
          fi

          run_id="${FACTORY_RUN_ID:-}"
          if [[ -z "$run_id" && -n "${GITHUB_RUN_ID:-}" ]]; then
            run_id="gh-${GITHUB_RUN_ID}-${ISSUE_NUMBER:-0}"
          fi

          if [[ -z "$run_id" ]]; then
            exit 0
          fi

          issue_number=0
          if [[ "${ISSUE_NUMBER:-}" =~ ^[0-9]+$ ]]; then
            issue_number="${ISSUE_NUMBER}"
          fi

          repo="${GITHUB_REPOSITORY:-unknown/unknown}"
          workflow_url="${GITHUB_SERVER_URL:-https://github.com}/${repo}/actions/runs/${GITHUB_RUN_ID:-}"
          started_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          workflow_run_id_json="null"
          if [[ "${GITHUB_RUN_ID:-}" =~ ^[0-9]+$ ]]; then
            workflow_run_id_json="${GITHUB_RUN_ID}"
          fi

          payload="$(jq -n \
            --arg repo "$repo" \
            --argjson issueNumber "$issue_number" \
            --arg issueTitle "Issue #${issue_number}" \
            --arg taskType "feature" \
            --arg trigger "workflow" \
            --arg status "queued" \
            --arg workflowUrl "$workflow_url" \
            --arg startedAt "$started_at" \
            --arg log "Workflow started" \
            --argjson workflowRunId "$workflow_run_id_json" \
            '{
              repo: $repo,
              issueNumber: $issueNumber,
              issueTitle: $issueTitle,
              taskType: $taskType,
              trigger: $trigger,
              status: $status,
              workflowRunId: $workflowRunId,
              workflowUrl: $workflowUrl,
              startedAt: $startedAt,
              log: $log
            }'
          )"

          curl -s -X PATCH \
            "${FACTORY_API_URL%/}/api/agent-runs/external/${run_id}" \
            -H "Content-Type: application/json" \
            -H "X-Factory-Agents-Token: ${FACTORY_API_TOKEN}" \
            -d "$payload" > /dev/null 2>&1 || true

      - name: Research
        shell: bash
        run: |
          "$ACTION_PATH/scripts/research.sh"

      - name: Plan
        shell: bash
        run: |
          "$ACTION_PATH/scripts/plan.sh"

      - name: Implement
        id: implement
        shell: bash
        run: |
          "$ACTION_PATH/scripts/implement.sh"

      - name: Review
        shell: bash
        run: |
          "$ACTION_PATH/scripts/review.sh"
